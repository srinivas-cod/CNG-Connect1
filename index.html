<!DOCTYPE html>
<html>
<head>
  <title>CNG Connect (Chennai)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    #nearestBtn {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: #28a745;
      color: white;
      font-weight: bold;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #nearestBtn:hover {
      background: #218838;
    }
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border: 1px solid #999;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #legend div {
      margin: 4px 0;
    }
    #legend img {
      vertical-align: middle;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <button id="nearestBtn">Go to Nearest Station</button>
  <div id="map"></div>
  <div id="legend">
    <h4>Legend</h4>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png" width="24"> Available</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" width="24"> 15 min Queue</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" width="24"> Not Available</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="24"> You</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    // âœ… 8 sample CNG stations in Chennai
    const stations = [
      { name: "CNG Station 1 - T. Nagar", location: [13.0418, 80.2337], status: "available" },
      { name: "CNG Station 2 - Guindy", location: [13.0108, 80.2209], status: "queue" },
      { name: "CNG Station 3 - Velachery", location: [12.9792, 80.2212], status: "not" },
      { name: "CNG Station 4 - Saidapet", location: [13.0211, 80.2362], status: "available" },
      { name: "CNG Station 5 - Adyar", location: [13.0067, 80.2573], status: "queue" },
      { name: "CNG Station 6 - Perungudi", location: [12.9623, 80.2400], status: "not" },
      { name: "CNG Station 7 - Anna Nagar", location: [13.0878, 80.2101], status: "available" },
      { name: "CNG Station 8 - Tambaram", location: [12.9229, 80.1275], status: "queue" }
    ];

    let map = L.map("map").setView([13.0418, 80.2337], 12);

    // Add OSM tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Icons for different statuses
    const icons = {
      available: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
      queue: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      not: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
    };

    // Add station markers
    stations.forEach(station => {
      const marker = L.marker(station.location, { icon: L.icon({
        iconUrl: icons[station.status],
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      }) }).addTo(map);

      marker.bindTooltip(`${station.name}<br>Status: ${
        station.status === "available" ? "Available" :
        station.status === "queue" ? "15 min Queue" : "Not Available"
      }`);
    });

    let userMarker = null;
    let routingControl = null;

    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLoc = [pos.coords.latitude, pos.coords.longitude];
        userMarker = L.marker(userLoc, { icon: L.icon({
          iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        }) }).addTo(map).bindPopup("You are here").openPopup();

        map.setView(userLoc, 13);
      }, () => {
        alert("Enable location services to use this feature.");
      });
    }

    // Button: Find nearest station & draw route
    document.getElementById("nearestBtn").addEventListener("click", () => {
      if (!userMarker) {
        alert("Location not available yet.");
        return;
      }

      const userLoc = userMarker.getLatLng();
      let nearest = null;
      let minDist = Infinity;

      stations.forEach(station => {
        const dist = map.distance(userLoc, station.location);
        if (dist < minDist) {
          minDist = dist;
          nearest = station;
        }
      });

      if (nearest) {
        if (routingControl) {
          map.removeControl(routingControl);
        }
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLoc.lat, userLoc.lng),
            L.latLng(nearest.location[0], nearest.location[1])
          ],
          routeWhileDragging: false,
          show: false,
          addWaypoints: false,
          draggableWaypoints: false,
          createMarker: function() { return null; } // only our custom markers
        }).addTo(map);
      }
    });
  </script>
</body>
</html>
